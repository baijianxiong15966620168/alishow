<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="utf-8">
  <title>Users &laquo; Admin</title>
  <link rel="stylesheet" href="../assets/vendors/bootstrap/css/bootstrap.css">
  <link rel="stylesheet" href="../assets/vendors/font-awesome/css/font-awesome.css">
  <link rel="stylesheet" href="../assets/vendors/nprogress/nprogress.css">
  <link rel="stylesheet" href="../assets/css/admin.css">
  <script src="../assets/vendors/nprogress/nprogress.js"></script>

</head>

<body>
  <script>NProgress.start()</script>

  <div class="main">
    <nav class="navbar">
      <button class="btn btn-default navbar-btn fa fa-bars"></button>
      <ul class="nav navbar-nav navbar-right">
        <li><a href="profile.html"><i class="fa fa-user"></i>个人中心</a></li>
        <li><a href="login.html"><i class="fa fa-sign-out"></i>退出</a></li>
      </ul>
    </nav>
    <div class="container-fluid">
      <div class="page-title">
        <h1>用户</h1>
      </div>
      <!-- 有错误信息时展示 -->
      <!-- <div class="alert alert-danger">
        <strong>错误！</strong>发生XXX错误
      </div> -->
      <div class="row">
        <div class="col-md-4">
          <form id="users_form">
            <h2>添加新用户</h2>
            <div class="form-group">
              <label for="email">邮箱</label>
              <input id="email" class="form-control" name="admin_email" type="email" placeholder="邮箱">
            </div>
            <div class="form-group">
              <label for="slug">别名</label>
              <input id="slug" class="form-control" name="admin_slug" type="text" placeholder="slug">
              <p class="help-block">https://example.com/author/<strong>slug</strong></p>
            </div>
            <div class="form-group">
              <label for="nickname">昵称</label>
              <input id="nickname" class="form-control" name="admin_nickname" type="text" placeholder="昵称">
            </div>
            <div class="form-group">
              <label for="password">密码</label>
              <input id="password" class="form-control" name="admin_password" type="text" placeholder="密码">
            </div>
            <div class="form-group">
              <button class="btn btn-primary" type="submit">添加</button>
            </div>
          </form>
        </div>
        <div class="col-md-8">
          <div class="page-action">
            <!-- show when multiple checked -->
            <a class="btn btn-danger btn-sm" href="javascript:;" style="display: none">批量删除</a>
          </div>
          <table class="table table-striped table-bordered table-hover">
            <thead>
              <tr>
                <th class="text-center" width="40"><input type="checkbox"></th>
                <th class="text-center" width="80">头像</th>
                <th>邮箱</th>
                <th>别名</th>
                <th>昵称</th>
                <th>状态</th>
                <th class="text-center" width="100">操作</th>
              </tr>
            </thead>
            <tbody>

            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <!-- 编辑模态框 -->
<div class="modal fade" id="edit_modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="exampleModalLabel">用户信息修改</h4>
      </div>
      <div class="modal-body">
        <!-- 这是from表单 -->
        <form id="edit_form">
          <div class="form-group">
            <label for="message-text" class="control-label">新头像:</label>
            <!-- 上传内容的文本框 -->
            <input type="text" class="form-control" name="admin_pic">
          </div>
          <div class="form-group">
            <label for="recipient-name" class="control-label">新邮箱:</label>
            <!-- 上传内容的文本框 -->
            <input type="text" class="form-control" name="admin_email">
          </div>
          <div class="form-group">
            <label for="message-text" class="control-label">新别名:</label>
            <!-- 上传内容的文本框 -->
            <input type="text" class="form-control" name="admin_slug">
          </div>
          <div class="form-group">
            <label for="message-text" class="control-label">新昵称:</label>
            <!-- 上传内容的文本框 -->
            <input type="text" class="form-control" name="admin_nickname">
          </div>
          <div class="form-group">
            <label for="message-text" class="control-label">新状态:</label>
            <!-- 上传内容的文本框 -->
            <input type="text" class="form-control" name="admin_state">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
        <button type="button" class="btn " id="btn_edit">保存修改</button>
      </div>
    </div>
  </div>
</div>
<!-- /编辑模态框 -->
  <div class="aside">
    <div class="profile">
      <img class="avatar" src="../assets/img/avatar-max-img.png">
      <h3 class="name">管理员</h3>
    </div>
    <ul class="nav">
      <li>
        <a href="index.html"><i class="fa fa-dashboard"></i>仪表盘</a>
      </li>
      <li>
        <a href="#menu-posts" class="collapsed" data-toggle="collapse">
          <i class="fa fa-thumb-tack"></i>文章<i class="fa fa-angle-right"></i>
        </a>
        <ul id="menu-posts" class="collapse">
          <li><a href="posts.html">所有文章</a></li>
          <li><a href="post-add.html">写文章</a></li>
          <li><a href="categories.html">分类目录</a></li>
        </ul>
      </li>
      <li>
        <a href="comments.html"><i class="fa fa-comments"></i>评论</a>
      </li>
      <li class="active">
        <a href="users.html"><i class="fa fa-users"></i>用户</a>
      </li>
      <li>
        <a href="#menu-settings" class="collapsed" data-toggle="collapse">
          <i class="fa fa-cogs"></i>设置<i class="fa fa-angle-right"></i>
        </a>
        <ul id="menu-settings" class="collapse">
          <li><a href="nav-menus.html">导航菜单</a></li>
          <li><a href="slides.html">图片轮播</a></li>
          <li><a href="settings.html">网站设置</a></li>
        </ul>
      </li>
    </ul>
  </div>

  <script src="../assets/vendors/jquery/jquery.js"></script>
  <script src="../assets/vendors/bootstrap/js/bootstrap.js"></script>
  <script src="../../node_modules/jquery-validation/dist/jquery.validate.js"></script>
  <script src="../../node_modules/jquery-validation/dist/localization/messages_zh.js"></script>
  <script src="../../node_modules/art-template/lib/template-web.js"></script>
  <script type="text/template" id="users_list">
    {%each data value %}
    <tr>
      <td class="text-center"><input type="checkbox"></td>
      <td class="text-center"><img class="avatar" src="../assets/img/default.png"></td>
      <td>{% value.admin_email%}</td>
      <td>{% value.admin_slug%}</td>
      <td>{% value.admin_nickname%}</td>
      <td>{% value.admin_state%}</td>
      <td class="text-center">
        <a href="javascript:;" class="btn btn-default btn-xs" admin_id="{% value.admin_id%}" >编辑</a>
        <a href="javascript:;" class="btn btn-danger btn-xs" admin_id="{% value.admin_id%}">删除</a>
      </td>
    </tr>
    {%/each%}
  </script>
  <script>
    // 点开页面时，需要把数据已有的数据渲染到页面上
    template.defaults.rules[1].test = /{%([@#]?)[ \t]*(\/?)([\w\W]*?)[ \t]*%}/;
    usersSearch();
    usersDelete();
    usersEdit();
    usersSavaChange();
    let adminId ;
    
   
    // 编辑请求
    function usersEdit() { 
      $('tbody').on('click','.btn-default',function() {
         adminId = $(this).attr('admin_id');
        let admin_id = $(this).attr('admin_id');
        $.ajax({
          url:'/api/users/edit',
          data: {admin_id:admin_id},
          type: 'get',
          dataType: 'json',
          cache:false,
          success: function (msg) {
            $('#edit_modal').modal('show');
            $('input[name=admin_pic]').val(msg.data[0].admin_pic)                     
            $('input[name=admin_email]').val(msg.data[0].admin_email)            
            $('input[name=admin_slug]').val(msg.data[0].admin_slug)
            $('input[name=admin_nickname]').val(msg.data[0].admin_nickname)
            $('input[name=admin_state]').val(msg.data[0].admin_state)                  
          },
          error: function (err) {
            console.log(err);
          },
          });
      })
    }

    // 保存修改操作请求
     function usersSavaChange() { 
      $('#btn_edit').click(function ()  { 
        let formData = $('#edit_form').serialize();
        $.ajax({
          url:'/api/users/change?admin_id=' + adminId,
          data: formData,
          type: 'post',
          dataType: 'json',
          success: function (msg) {
            // console.log(msg)
            usersSearch();
            $('#edit_modal').modal('hide');
          },
          error: function (err) {
            console.log(err);
          },
        });
      })
    }
    // 添加删除请求
    function usersDelete() { 
      $('tbody').on('click','.btn-danger',function() { 
        if(!confirm('你确定删除吗')){
          return;
        }
        let users_id = $(this).attr('admin_id');
        $.ajax({
          url:'/api/users/delete',
          data: {users_id:users_id},
          type: 'get',
          dataType: 'json',
          success: function (msg) {
            console.log(msg)
          },
          error: function (err) {
            console.log(err);
          },
        });
        usersSearch();
      });
    };

    $('#users_form').validate({
      rules: {
        admin_email: {
          required: true,
          email: true,
          remote:'/api/users/email'
        },
        admin_slug: {
          required: true,
        },
        admin_nickname: {
          required: true,
          minlength: 2,
        },
        admin_password: {
          required: true,
          minlength: 5,
        }
      },
      messages: {
        admin_email: {
          required: '请输入邮箱地址',
          email: '请输入正确的邮箱地址',
          remote:'邮箱以占用，请重新输入'
        },
        admin_slug: {
          required: '请输入别名',
        },
        admin_nickname: {
          required: '请输入昵称',
          minlength: '至少输入两位',
        },
        admin_password: {
          required: '请输入密码',
          minlength: '至少输入五位数',
        },
      },
      submitHandler: usersAdd
    })

    function usersAdd() {
      // 发送一个请求添加新用户
        let data = $('#users_form').serialize();
        $.ajax({
          url: '/api/users/add',
          data: data,
          type: 'post',
          dataType: 'json',
          success: function (msg) {
            if (msg.code !== 200 && msg.message !== '添加成功') {
              return alert(msg.message)
            }
            usersSearch();
            $('#users_form').find('input[name]').val('')
          },
          error: function (err) {
            console.log(err);
          },
        });
    }

    function usersSearch() {
      // 发送一个请求，请求数据库admin的数据，然后渲染到页面
      $.ajax({
        url: '/api/users/search',
        data: '',
        type: 'get',
        cache:false,
        dataType: 'json',
        success: function (msg) {
          let str = template('users_list', msg);
          $('tbody').html(str);
        },
        error: function (err) {
          console.log(err);
        },
      });
    }
  </script>

  <script>
    NProgress.done()
  </script>
</body>

</html>